# -*- ruby -*-

require "net/http"
require "uri"
require "pathname"
require "json"
require "pp"

def path_to_uri(path)
  components = path.expand_path.to_s.split(Pathname::SEPARATOR_PAT)
  escaped_components = components.collect do |component|
    CGI.escape(component)
  end
  "file://" + File.join(*escaped_components)
end

api_uri = URI("http://localhost:3000/scraping.json")
ARGV.each do |path|
  response = Net::HTTP.post_form(api_uri,
                                 {
                                   "uri" => path_to_uri(Pathname(path)),
                                   "mime_type" => "message/rfc822",
                                   "body" => File.read(path),
                                 })
  p response
  pp JSON.parse(response.body)
end
